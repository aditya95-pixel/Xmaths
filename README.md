# Project Documentation

## Why did we use MongoDB for Xmaths?

1. **Flexible Schema** : Future features might introduce new types of messages.  With MongoDB, we can easily add new fields to our messages array or even new top-level fields to Chat documents without requiring complex migrations that would be necessary in a relational database.

2. **Document Model (JSON-like Documents)** : Embedded Documents: The messages array within the Chat document is a perfect example of MongoDB's document model strength. All the messages for a specific chat are stored together in a single document. This reduces the number of queries needed to retrieve a full chat conversation, as you fetch one Chat document and get all its related messages, leading to faster read performance for chat history.

3. **Scalability (Horizontal Scaling)** : We can distribute our data across multiple servers (shards) as our data volume or traffic increases, allowing us to scale out gracefully without needing to upgrade to larger, more expensive single servers. This "scale-out" approach is generally more cost-effective and resilient than "scale-up."(vertical scaling)

4. **Performance for Read-Heavy Workloads**

## Role Of Mongoose in Our Project 

Mongoose is an Object Data Modeling (ODM) library for MongoDB and Node.js. It provides a straightforward, schema-based solution to model our application data, enforcing a structure on the otherwise schemaless MongoDB documents.

## Database Models

### MongoDB User Collection Schema – Xmaths App (Clerk Auth + Webhook)

This document outlines the structure of the `User` collection in the **Xmaths** application. Users are managed via **Clerk**, and user records are synchronized to MongoDB using a **Webhook Handler** in `app/api/clerk/route.js`.

---

#### Webhook Handler

Webhook events handled from Clerk:

- `user.created` → Creates a new user in the MongoDB `User` collection.
- `user.updated` → Updates an existing user record.
- `user.deleted` → Deletes the user from the database.

Webhook route:
```js
// file: app/api/clerk/route.js
const userData={
        _id:data.id,
        email:data.email_addresses[0].email_address,
        name:`${data.first_name} ${data.last_name}`,
        image:data.image_url,
    };
switch (type) {
  case "user.created":
    await User.create(userData);
    break;
  case "user.updated":
    await User.findByIdAndUpdate(data.id, userData);
    break;
  case "user.deleted":
    await User.findByIdAndDelete(data.id);
    break;
}
```

| **Field Name** | **Type** | **Required** | **Description**                                         | **Source from Clerk**                    |
| -------------- | -------- | ------------ | ------------------------------------------------------- | ---------------------------------------- |
| `_id`          | String   |  Yes        | Unique Clerk User ID (used as MongoDB \_id).            | `data.id`                                |
| `email`        | String   |  Yes        | User's primary email address.                           | `data.email_addresses[0].email_address`  |
| `name`         | String   |  Yes        | Full name of the user (first + last).                   | `data.first_name + " " + data.last_name` |
| `image`        | String   |  No         | Profile image URL from Clerk.                           | `data.image_url`                         |
| `createdAt`    | Date     |  Yes        | Auto-generated timestamp when user is added to MongoDB. | Mongoose `timestamps`                    |
| `updatedAt`    | Date     |  Yes        | Auto-updated timestamp when user data changes.          | Mongoose `timestamps`                    |

### Chat Collection Schema 

This document outlines the structure of the **Chat** collection in the MongoDB database. This collection stores individual chat sessions between users and the **Xmaths AI assistant**, including full conversation history.

---

#### Collection: `Chat`

| **Field Name**     | **Type**               | **Required** | **Description**                                                   | **Notes** |
|--------------------|------------------------|--------------|-------------------------------------------------------------------|-----------|
| `_id`              | `ObjectId`             |  Yes       | Unique identifier for the chat session.                          | Auto-generated by MongoDB/Mongoose. |
| `name`             | `String`               |  Yes       | A user-friendly name/title for the chat session.                 | Could be the initial user query, a summary, or a custom name (e.g., *"Linear Algebra: Eigenvalues"*). |
| `messages`         | `Array<Object>`        |  Yes       | Ordered list of messages exchanged in this chat session.         | Embedded subdocuments. Efficient for retrieving full conversation. |
| `messages[].role`  | `String`               |  Yes       | Sender of the message: `"user"` or `"system"`.                | Used to render messages in UI properly. |
| `messages[].content` | `String`             |  Yes       | Text content of the message. Includes queries, responses, LaTeX, etc. | Can include mathematical formulas, code snippets, etc. |
| `messages[].timestamp` | `String`           |  Yes       | Time when the message was created.                               | - |
| `userId`           | `String`               |  Yes       | Reference to the `_id` of the user who owns the chat.            | - |
| `createdAt`        | `Date`                 |  Yes       | When the chat document was created.                              | Managed automatically by Mongoose (`timestamps: true`). |
| `updatedAt`        | `Date`                 |  Yes       | When the chat document was last updated.                         | Updated on each message addition or edit. |

---
